# ec2-snapshot-share

This is a sap-app template for a Lambda function to share all Snapshots in a Production account with it's Development counter part:

```bash
.
├── README.md                   <-- This instructions file
├── event.json                  <-- Test event payload
├── ec2-snapshot-share          <-- Source code for a lambda function
│   ├── __init__.py
│   ├── app.py                  <-- Lambda function code
│   ├── requirements.txt        <-- Lambda function code
├── template.yaml               <-- SAM Template
└── tests                       <-- Unit tests (UNUSED)
    └── unit
        ├── __init__.py
        └── test_handler.py
```

## Implementation

This script is called from Cloudwatch Events. 

```json
{
  "detail-type": [
    "EBS Snapshot Notification"
  ],
  "source": [
    "aws.ec2"
  ],
  "detail": {
    "result": [
      "succeeded"
    ],
    "event": [
      "createSnapshot"
    ]
  }
}
```

## Caveats

* Cloudwatch EBS Events cannot filter on volume source. 
* Name tag is not available as it's not created in the source.  This means you must know the volume id prior to searching for your snapshot. 

## Requirements

* AWS CLI already configured with Administrator permission
* [Python 2.7 installed](https://www.python.org/downloads/)
* [Docker installed](https://www.docker.com/community-edition)
* User permissions against all CMK used to encrypt EBS volumes. 

## Setup process

### Local development

**Invoking function locally using a local sample payload**

```bash
sam local invoke --event event.json EC2SnapshotShareFunction
```

## Packaging and deployment

AWS Lambda Python runtime requires a flat folder with all dependencies including the application. SAM will use `CodeUri` property to know where to look up for both application and dependencies:

```yaml
...
  EC2SnapshotShareFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ec2-snapshot-share/
            ...
```

### The easy way

Make any changes you require and test them using the local invoke (as above).  

Edit the template.yaml file and change the `DEST_ACCOUNT` to reflect your destination account you are sharing to; 

```yaml
      Environment:
        Variables:
          DEST_ACCOUNT: 'xxxxxxxxxx'
```

Then simply use the deploy command.

(You may need to make an `S3 bucket` and amend the script to reflect your installation bucket)

```bash
./deploy.sh
```

This is basically a premade deployment script:

```bash
#!/bin/bash

sam package --template-file template.yaml --output-template-file ec2-snapshot-share.yaml --s3-bucket mybucket
aws cloudformation deploy --template-file ec2-snapshot-share.yaml --stack-name ec2-snapshot-share --capabilities CAPABILITY_IAM --region ap-southeast-2
```

This will deploy the package into your bucket and then initilise a Cloudformation Stack _OR_ create a change set and apply it to the stack. 

### The "DIY" method

Firstly, we need a `S3 bucket` where we can upload our Lambda functions packaged as ZIP before we deploy anything - If you don't have a S3 bucket to store code artifacts then this is a good time to create one:

```bash
aws s3 mb s3://BUCKET_NAME
```

Next, run the following command to package our Lambda function to S3:

```bash
sam package \
    --output-template-file packaged.yaml \
    --s3-bucket REPLACE_THIS_WITH_YOUR_S3_BUCKET_NAME
```

Next, the following command will create a Cloudformation Stack and deploy your SAM resources.

```bash
sam deploy \
    --template-file packaged.yaml \
    --stack-name sam-app \
    --capabilities CAPABILITY_IAM
```

> **See [Serverless Application Model (SAM) HOWTO Guide](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-quick-start.html) for more details in how to get started.**

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, SAM CLI has a command called sam logs. sam logs lets you fetch logs generated by your Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

`NOTE`: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
sam logs -n EC2SnapshotShare --stack-name sam-app --tail
```

You can find more information and examples about filtering Lambda function logs in the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html).


## Cleanup

In order to delete our Serverless Application recently deployed you can use the following AWS CLI Command:

```bash
aws cloudformation delete-stack --stack-name sam-app
```
